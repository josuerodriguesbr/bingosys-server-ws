<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingoSys - Painel Ao Vivo</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        body {
            overflow-y: auto;
            min-height: 100vh;
        }

        /* Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 1rem;
            padding: 1rem;
            min-height: 100vh;
        }

        /* Mobile Responsiveness */
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: visible;
            }

            .main-grid aside,
            .main-grid main {
                height: auto !important;
                min-height: unset;
            }

            /* Order: Main Content -> Boa -> Ganhadores */
            .main-grid main {
                order: 1;
            }

            .main-grid aside:nth-of-type(1) {
                order: 2;
            }

            .main-grid aside:nth-of-type(2) {
                order: 3;
            }

            .ticket-list {
                max-height: 300px !important;
            }

            .big-ball {
                width: 60vw !important;
                height: 60vw !important;
                font-size: 20vw !important;
            }

            .admin-controls {
                position: relative !important;
                top: 0 !important;
                right: 0 !important;
                margin-bottom: 2rem;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        /* Last Calls Bar */
        .balls-history {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .ball.last {
            background: var(--warning);
            color: #000;
            border-color: #fff;
            transform: scale(1.1);
        }

        /* Current Call - The Big One */
        .current-ball-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .big-ball {
            width: 25vw;
            height: 25vw;
            max-width: 300px;
            max-height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--accent-primary), #1e3a8a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 0 50px var(--accent-glow), inset 0 0 20px rgba(255, 255, 255, 0.3);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 1rem;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Lists */
        .ticket-list {
            list-style: none;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        .ticket-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--text-secondary);
        }

        .ticket-item.winner {
            background: rgba(34, 197, 94, 0.2);
            border-left-color: var(--success);
            animation: pulse 2s infinite;
        }

        .ticket-item.near-1 {
            border-left-color: var(--warning);
        }

        /* Bingo Grid Visualization */
        .ticket-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .ticket-card.winner {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }

        .ticket-card.near-1 {
            border-color: var(--warning);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .bingo-container {
            user-select: none;
        }

        .bingo-labels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            text-align: center;
            font-weight: 900;
            color: var(--accent-glow);
            font-size: 0.75rem;
            margin-bottom: 4px;
            letter-spacing: 2px;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }

        .bingo-cell {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            border-radius: 4px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .bingo-cell.marked {
            background: rgba(34, 197, 94, 0.3);
            border-color: var(--success);
            color: white;
            box-shadow: inset 0 0 8px rgba(34, 197, 94, 0.2);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        /* Admin Controls */
        .admin-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 1rem;
            z-index: 100;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            backdrop-filter: blur(5px);
            align-items: center;
        }

        .input-manual {
            width: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .more-badge {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.5rem;
            text-align: center;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-style: italic;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            margin-top: 0.5rem;
        }

        .sorteio-id-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            border: 1px solid var(--accent-glow);
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 2px;
        }

        /* Top Menu Bar */
        .top-navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-glow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .nav-btn.primary {
            background: var(--accent-primary);
            border-color: transparent;
        }

        /* Modal Settings */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: var(--bg-secondary);
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
        }

        .form-select {
            width: 100%;
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
            appearance: none;
            cursor: pointer;
        }

        .form-select option {
            background: #0f172a;
            color: white;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .mode-badge {
            font-size: 0.75rem;
            background: rgba(var(--accent-primary-rgb), 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            color: var(--accent-glow);
            border: 1px solid rgba(var(--accent-primary-rgb), 0.3);
        }
    </style>
</head>

<body>

    <nav class="top-navbar">
        <div class="nav-logo">BINGOSYS</div>
        <div id="game-status-badge" class="nav-actions">
            <div id="mode-display" class="mode-badge">75 Bolas | 1 Chance</div>
            <a href="vendas.html" class="nav-btn">üõí VENDAS</a>
            <button onclick="openSettings()" class="nav-btn">‚öôÔ∏è PREFER√äNCIAS</button>
            <button onclick="logout()" class="nav-btn" style="color: var(--danger)">üö™ SAIR</button>
        </div>
    </nav>

    <div class="main-grid">
        <!-- Left: Near Wins (Good) -->
        <aside class="glass-panel" style="padding: 1rem; display: flex; flex-direction: column;">
            <div class="section-title">Boa (Falta 1)</div>
            <ul id="list-near-1" class="ticket-list" style="flex: 1;">
                <!-- Items injected via JS -->
            </ul>
            <div id="more-near-1" class="more-badge" style="display: none;"></div>
        </aside>

        <!-- Center: Highlights -->
        <main class="glass-panel" style="position: relative; overflow: hidden;">
            <div class="current-ball-display">
                <div
                    style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase;">
                    √öltima Bola</div>
                <div id="current-ball" class="big-ball">--</div>
                <div id="sorteio-label" class="sorteio-id-box">PROVA #001</div>
                <div id="playing-count"
                    style="margin-top: 0.5rem; color: var(--success); font-size: 0.9rem; font-weight: 600;">0 CARTELAS
                    EM JOGO</div>
            </div>

            <!-- Bottom: History -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.3); padding: 1rem;">
                <div style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">HIST√ìRICO</div>
                <div id="history-row" class="balls-history">
                    <!-- Balls injected here -->
                </div>
            </div>

            <!-- Admin Controls Overlay -->
            <div class="admin-controls">
                <div
                    style="display: flex; align-items: center; gap: 0.5rem; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 1rem; margin-right: 0.5rem;">
                    <input type="number" id="manual-num" class="input-manual" placeholder="00" min="1" max="90">
                    <button id="btn-confirm" onclick="drawManual()"
                        style="background: var(--accent-primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600;">CONFIRMAR</button>
                </div>
                <button id="btn-random" onclick="drawRandomNumber()"
                    style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; margin-right: 0.5rem;">ALEAT√ìRIO</button>
                <button id="btn-undo" onclick="undoLast()"
                    style="background: var(--warning); color: #000; border: none; padding: 0.5rem 0.75rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; font-size: 0.8rem; margin-right: 0.5rem;">DESFAZER</button>
                <button id="btn-reset" onclick="requestNewGame()"
                    style="background: var(--danger); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; font-size: 0.8rem;">RESET</button>
            </div>
        </main>

        <!-- Right: Winners -->
        <aside class="glass-panel" style="padding: 1rem; display: flex; flex-direction: column;">
            <div class="section-title" style="color: var(--success); border-color: var(--success);">Ganhadores!</div>
            <ul id="list-winners" class="ticket-list" style="flex: 1;">
                <!-- Winners... -->
            </ul>
            <div id="more-winners" class="more-badge" style="display: none;"></div>
        </aside>
    </div>

    <!-- Modal Preferences -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">Prefer√™ncias do Sorteio</div>
            </div>

            <div class="form-group">
                <label class="form-label">Modo de Jogo</label>
                <select id="cfg-mode" class="form-select">
                    <!-- Dinamicamente preenchido -->
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Quantidade de Chances</label>
                <input type="number" id="cfg-chances" class="form-input" value="1" min="1" max="10">
                <small style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem; display: block;">
                    Um bip registrar√° esta quantidade de cartelas em sequ√™ncia.
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">Limite de Hist√≥rico (P√∫blico)</label>
                <input type="number" id="cfg-history-limit" class="form-input" value="10" min="1" max="50">
                <small style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem; display: block;">
                    Quantidade de √∫ltimas bolas que aparecem na tela do cliente.
                </small>
            </div>

            <div class="modal-footer">
                <button onclick="closeSettings()" class="nav-btn">Cancelar</button>
                <button onclick="saveSettings()" class="nav-btn primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script src="js/socket.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check access before doing anything
        if (!BingoAuth.checkAccess(true)) {
            // checkAccess handles redirect
        }
        // DOM Elements
        const elCurrentBall = document.getElementById('current-ball');
        const elHistory = document.getElementById('history-row');
        const elListNear1 = document.getElementById('list-near-1');
        const elListWinners = document.getElementById('list-winners');
        const elMoreNear1 = document.getElementById('more-near-1');
        const elMoreWinners = document.getElementById('more-winners');
        const elManualInput = document.getElementById('manual-num');

        // State
        let drawnNumbers = [];
        let lastWinners = [];
        let lastNearWins = {};
        let config = {
            maxBalls: 75,
            gridIndex: 0,
            numChances: 1,
            modeName: " Bingo 75 x 15 (Cl√°ssico)",
            historyLimit: 10
        };
        let availableModes = [];
        let showAllWinners = false;
        let showAllNear1 = false;

        // Socket Events
        bingoSocket.on('connected', () => {
            console.log('Painel conectado!');
        });

        bingoSocket.on('sync_status', (data) => {
            // Sincroniza vendas
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = data.totalRegistered + " CARTELAS EM JOGO";

            // Sincroniza bolas
            drawnNumbers = data.drawnNumbers || [];
            elHistory.innerHTML = "";
            drawnNumbers.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'ball animate-fade-in'; // Usando classe consistente
                ball.textContent = num < 10 ? '0' + num : num;
                elHistory.insertBefore(ball, elHistory.firstChild);
            });

            if (drawnNumbers.length > 0) {
                const last = drawnNumbers[drawnNumbers.length - 1];
                elCurrentBall.textContent = last < 10 ? '0' + last : last;
            } else {
                elCurrentBall.textContent = "--";
            }

            // Sincroniza listas
            if (data.winners) {
                lastWinners = data.winners;
                updateWinners(lastWinners);
            }
            if (data.near_wins) {
                lastNearWins = data.near_wins;
                updateNearWins(lastNearWins);
            }

            // Sincroniza Configura√ß√µes
            if (data.maxBalls) config.maxBalls = data.maxBalls;
            if (data.gridIndex) config.gridIndex = data.gridIndex;
            if (data.numChances) config.numChances = data.numChances;
            if (data.historyLimit) config.historyLimit = data.historyLimit;

            if (data.modes) {
                availableModes = data.modes;
                populateModesList();
            }

            updateConfigBadge();
        });

        bingoSocket.on('config_updated', (data) => {
            config.maxBalls = data.maxBalls;
            config.gridIndex = data.gridIndex;
            config.numChances = data.numChances;
            config.historyLimit = data.historyLimit;
            updateConfigBadge();

            // Sincroniza campos se o administrador estiver com o modal aberto
            syncSettingsFields();
        });

        bingoSocket.on('number_drawn', (data) => {
            const num = data.number;
            drawnNumbers.push(num);
            updateDisplay(num);

            // Re-renderiza listas para atualizar destaques nos grids
            updateWinners(lastWinners);
            updateNearWins(lastNearWins);
        });

        bingoSocket.on('number_cancelled', (data) => {
            const num = data.number;
            // Remove do array
            drawnNumbers = drawnNumbers.filter(n => n !== num);

            // Remove do hist√≥rico visual (primeiro filho)
            if (elHistory.firstChild) elHistory.removeChild(elHistory.firstChild);

            // Atualiza a bola grande para a anterior
            if (drawnNumbers.length > 0) {
                const last = drawnNumbers[drawnNumbers.length - 1];
                elCurrentBall.textContent = last < 10 ? '0' + last : last;
            } else {
                elCurrentBall.textContent = "--";
            }

            // Atualiza listas
            if (data.winners) updateWinners(data.winners);
            if (data.near_wins) updateNearWins(data.near_wins);

            // Re-renderiza para atualizar destaques
            updateWinners(lastWinners);
            updateNearWins(lastNearWins);
        });

        bingoSocket.on('ticket_registered', (data) => {
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = data.totalRegistered + " CARTELAS EM JOGO";
        });

        bingoSocket.on('sales_cleared', (data) => {
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = "0 CARTELAS EM JOGO";
        });

        bingoSocket.on('game_update', (data) => {
            if (data.winners) updateWinners(data.winners);
            if (data.near_wins) updateNearWins(data.near_wins);
        });

        bingoSocket.on('game_started', () => {
            resetBoard();
        });

        // Admin Actions
        function requestNewGame() {
            if (confirm("Deseja iniciar um novo jogo? Isso limpar√° o sorteio atual.")) {
                bingoSocket.send("start_game");
            }
        }

        function undoLast() {
            if (drawnNumbers.length === 0) return;
            if (confirm("Deseja cancelar a √∫ltima bola sorteada (" + drawnNumbers[drawnNumbers.length - 1] + ")?")) {
                bingoSocket.send("undo_last");
            }
        }

        function drawRandomNumber() {
            if (drawnNumbers.length >= config.maxBalls) {
                alert("Todos os n√∫meros j√° foram sorteados!");
                return;
            }

            let num;
            do {
                num = Math.floor(Math.random() * config.maxBalls) + 1;
            } while (drawnNumbers.includes(num));

            bingoSocket.send("draw_number", { number: num });
        }

        function drawManual() {
            const val = parseInt(elManualInput.value);
            if (isNaN(val) || val < 1 || val > config.maxBalls) {
                alert("Por favor, digite um n√∫mero entre 1 e " + config.maxBalls);
                return;
            }

            if (drawnNumbers.includes(val)) {
                alert("Este n√∫mero j√° foi sorteado!");
                return;
            }

            bingoSocket.send("draw_number", { number: val });
            elManualInput.value = '';
        }

        function updateDisplay(number) {
            // Update Big Ball
            // Trigger animation reset
            elCurrentBall.style.animation = 'none';
            elCurrentBall.offsetHeight; /* trigger reflow */
            elCurrentBall.style.animation = null;
            elCurrentBall.textContent = number < 10 ? '0' + number : number;

            // Add to history
            const ball = document.createElement('div');
            ball.className = 'ball animate-fade-in';
            ball.textContent = number;
            // Prepend
            elHistory.insertBefore(ball, elHistory.firstChild);
        }

        function updateWinners(winners) {
            lastWinners = winners || [];
            elListWinners.innerHTML = "";
            let toShow = [...lastWinners];

            if (toShow.length > 3 && !showAllWinners) {
                elMoreWinners.style.display = 'block';
                elMoreWinners.textContent = `+ ${toShow.length - 3} ganhadores`;
                toShow = toShow.slice(0, 3);
            } else {
                elMoreWinners.style.display = 'none';
            }

            toShow.forEach(ticket => {
                try {
                    const div = document.createElement('div');
                    div.className = 'ticket-card winner';
                    let gridHtml = renderBingoGrid(ticket.numbers);
                    div.innerHTML = `
                        <div class="ticket-header">
                            <span style="color: var(--success)">üèÜ #${ticket.barcode}</span>
                            <span>GANHOU!</span>
                        </div>
                        ${gridHtml}
                    `;
                    elListWinners.appendChild(div);
                } catch (e) { console.error("Erro ao renderizar vencedor:", e); }
            });
        }

        function updateNearWins(nearWins) {
            lastNearWins = nearWins || {};
            elListNear1.innerHTML = "";
            let list1 = lastNearWins["1"] || [];

            if (list1.length > 3 && !showAllNear1) {
                elMoreNear1.style.display = 'block';
                elMoreNear1.textContent = `+ ${list1.length - 3} armadas`;
                list1 = list1.slice(0, 3);
            } else {
                elMoreNear1.style.display = 'none';
            }

            list1.forEach(ticket => {
                try {
                    const div = document.createElement('div');
                    div.className = 'ticket-card near-1';
                    let gridHtml = renderBingoGrid(ticket.numbers);
                    div.innerHTML = `
                        <div class="ticket-header">
                            <span style="color: var(--warning)">üî• #${ticket.barcode}</span>
                            <span>FALTA 1</span>
                        </div>
                        ${gridHtml}
                    `;
                    elListNear1.appendChild(div);
                } catch (e) { console.error("Erro ao renderizar armada:", e); }
            });
        }

        function renderBingoGrid(numbers) {
            if (!numbers || numbers.length === 0) return "";

            const rows = numbers.length / 5;
            let html = `
                <div class="bingo-container">
                    <div class="bingo-labels">
                        <div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>
                    </div>
                    <div class="bingo-grid" style="grid-template-rows: repeat(${rows}, 1fr)">
            `;

            // Preenchimento coluna-primeiro (B-I-N-G-O)
            // Para cada linha r, visitamos cada coluna c
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < 5; c++) {
                    const idx = (c * rows) + r;
                    const val = numbers[idx];
                    const isMarked = drawnNumbers.includes(val);
                    html += `<div class="bingo-cell ${isMarked ? 'marked' : ''}">${val.toString().padStart(2, '0')}</div>`;
                }
            }
            html += `</div></div>`;
            return html;
        }

        function resetBoard() {
            elCurrentBall.textContent = "--";
            elHistory.innerHTML = "";
            elListNear1.innerHTML = "";
            elListWinners.innerHTML = "";
            elMoreNear1.style.display = 'none';
            elMoreWinners.style.display = 'none';
            drawnNumbers = [];
            lastWinners = [];
            lastNearWins = {};
            showAllWinners = false;
            showAllNear1 = false;
        }

        // Settings Modal Logic
        function openSettings() {
            document.getElementById('modal-settings').style.display = 'flex';
            syncSettingsFields();
        }

        function syncSettingsFields() {
            // Encontra o modo atual na lista
            const mode = availableModes.find(m => m.balls == config.maxBalls && m.grid == config.gridIndex);
            if (mode) {
                document.getElementById('cfg-mode').value = mode.id;
            }
            document.getElementById('cfg-chances').value = config.numChances;
            document.getElementById('cfg-history-limit').value = config.historyLimit || 10;
        }

        function closeSettings() {
            document.getElementById('modal-settings').style.display = 'none';
        }

        function saveSettings() {
            const modeId = parseInt(document.getElementById('cfg-mode').value);
            const numChances = parseInt(document.getElementById('cfg-chances').value);
            const historyLimit = parseInt(document.getElementById('cfg-history-limit').value);

            const mode = availableModes.find(m => m.id === modeId);
            if (!mode) return;

            bingoSocket.send("update_config", {
                maxBalls: mode.balls,
                gridIndex: mode.grid,
                numChances: numChances,
                historyLimit: historyLimit
            });

            closeSettings();
        }

        function populateModesList() {
            const select = document.getElementById('cfg-mode');
            select.innerHTML = "";
            availableModes.forEach(mode => {
                const opt = document.createElement('option');
                opt.value = mode.id;
                opt.textContent = mode.name;
                select.appendChild(opt);
            });
        }

        function updateConfigBadge() {
            const badge = document.getElementById('mode-display');
            if (badge) {
                const mode = availableModes.find(m => m.balls == config.maxBalls && m.grid == config.gridIndex);
                const modeName = mode ? mode.name : `${config.maxBalls} Bolas | Grade ${parseInt(config.gridIndex) + 1}`;
                badge.textContent = `${modeName} | ${config.numChances} Chance(s)`;
            }
            // Atualiza o placeholder do manual input
            elManualInput.max = config.maxBalls;
        }
        
        // Bot√£o de Sair
        function logout() {
            if(confirm("Deseja sair do painel?")) {
                BingoAuth.logout();
            }
        }
    </script>
</body>

</html>