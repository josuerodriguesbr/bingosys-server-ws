<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingoSys - Painel Ao Vivo</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        body {
            overflow-y: auto;
            min-height: 100vh;
        }

        /* Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 1rem;
            padding: 1rem;
            min-height: 100vh;
        }

        /* Mobile Responsiveness */
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: visible;
            }

            .main-grid aside,
            .main-grid main {
                height: auto !important;
                min-height: unset;
            }

            /* Order: Main Content -> Boa -> Ganhadores */
            .main-grid main {
                order: 1;
            }

            .main-grid aside:nth-of-type(1) {
                order: 2;
            }

            .main-grid aside:nth-of-type(2) {
                order: 3;
            }

            .ticket-list {
                max-height: 300px !important;
            }

            .big-ball {
                width: 60vw !important;
                height: 60vw !important;
                font-size: 20vw !important;
            }

            .admin-controls {
                position: relative !important;
                top: 0 !important;
                right: 0 !important;
                margin-bottom: 2rem;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        /* Last Calls Bar */
        .balls-history {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .ball.last {
            background: var(--warning);
            color: #000;
            border-color: #fff;
            transform: scale(1.1);
        }

        /* Current Call - The Big One */
        .current-ball-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .big-ball {
            width: 25vw;
            height: 25vw;
            max-width: 300px;
            max-height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--accent-primary), #1e3a8a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 0 50px var(--accent-glow), inset 0 0 20px rgba(255, 255, 255, 0.3);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 1rem;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Lists */
        .ticket-list {
            list-style: none;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        .ticket-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--text-secondary);
        }

        .ticket-item.winner {
            background: rgba(34, 197, 94, 0.2);
            border-left-color: var(--success);
            animation: pulse 2s infinite;
        }

        .ticket-item.near-1 {
            border-left-color: var(--warning);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        /* Admin Controls */
        .admin-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 1rem;
            z-index: 100;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            backdrop-filter: blur(5px);
            align-items: center;
        }

        .input-manual {
            width: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .more-badge {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.5rem;
            text-align: center;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-style: italic;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            margin-top: 0.5rem;
        }

        .sorteio-id-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            border: 1px solid var(--accent-glow);
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 2px;
        }

        /* Top Menu Bar */
        .top-navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-glow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .nav-btn.primary {
            background: var(--accent-primary);
            border-color: transparent;
        }

        /* Modal Settings */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: var(--bg-secondary);
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
        }

        .form-select {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
            appearance: none;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .mode-badge {
            font-size: 0.75rem;
            background: rgba(var(--accent-primary-rgb), 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            color: var(--accent-glow);
            border: 1px solid rgba(var(--accent-primary-rgb), 0.3);
        }
    </style>
</head>

<body>

    <nav class="top-navbar">
        <div class="nav-logo">BINGOSYS</div>
        <div id="game-status-badge" class="nav-actions">
            <div id="mode-display" class="mode-badge">75 Bolas | 1 Chance</div>
            <a href="vendas.html" class="nav-btn">üõí VENDAS</a>
            <button onclick="openSettings()" class="nav-btn">‚öôÔ∏è PREFER√äNCIAS</button>
        </div>
    </nav>

    <div class="main-grid">
        <!-- Left: Near Wins (Good) -->
        <aside class="glass-panel" style="padding: 1rem; display: flex; flex-direction: column;">
            <div class="section-title">Boa (Falta 1)</div>
            <ul id="list-near-1" class="ticket-list" style="flex: 1;">
                <!-- Items injected via JS -->
            </ul>
            <div id="more-near-1" class="more-badge" style="display: none;"></div>
        </aside>

        <!-- Center: Highlights -->
        <main class="glass-panel" style="position: relative; overflow: hidden;">
            <div class="current-ball-display">
                <div
                    style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase;">
                    √öltima Bola</div>
                <div id="current-ball" class="big-ball">--</div>
                <div id="sorteio-label" class="sorteio-id-box">PROVA #001</div>
                <div id="playing-count"
                    style="margin-top: 0.5rem; color: var(--success); font-size: 0.9rem; font-weight: 600;">0 CARTELAS
                    EM JOGO</div>
            </div>

            <!-- Bottom: History -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.3); padding: 1rem;">
                <div style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">HIST√ìRICO</div>
                <div id="history-row" class="balls-history">
                    <!-- Balls injected here -->
                </div>
            </div>

            <!-- Admin Controls Overlay -->
            <div class="admin-controls">
                <div
                    style="display: flex; align-items: center; gap: 0.5rem; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 1rem; margin-right: 0.5rem;">
                    <input type="number" id="manual-num" class="input-manual" placeholder="00" min="1" max="90">
                    <button id="btn-confirm" onclick="drawManual()"
                        style="background: var(--accent-primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600;">CONFIRMAR</button>
                </div>
                <button id="btn-random" onclick="drawRandomNumber()"
                    style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; margin-right: 0.5rem;">ALEAT√ìRIO</button>
                <button id="btn-undo" onclick="undoLast()"
                    style="background: var(--warning); color: #000; border: none; padding: 0.5rem 0.75rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; font-size: 0.8rem; margin-right: 0.5rem;">DESFAZER</button>
                <button id="btn-reset" onclick="requestNewGame()"
                    style="background: var(--danger); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; font-size: 0.8rem;">RESET</button>
            </div>
        </main>

        <!-- Right: Winners -->
        <aside class="glass-panel" style="padding: 1rem; display: flex; flex-direction: column;">
            <div class="section-title" style="color: var(--success); border-color: var(--success);">Ganhadores!</div>
            <ul id="list-winners" class="ticket-list" style="flex: 1;">
                <!-- Winners... -->
            </ul>
            <div id="more-winners" class="more-badge" style="display: none;"></div>
        </aside>
    </div>

    <!-- Modal Preferences -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">Prefer√™ncias do Sorteio</div>
            </div>

            <div class="form-group">
                <label class="form-label">Quantidade de Bolas no Globo</label>
                <select id="cfg-balls" class="form-select">
                    <option value="60">60 Bolas</option>
                    <option value="75" selected>75 Bolas</option>
                    <option value="90">90 Bolas</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Tipo de Cartela (Grade/Parte)</label>
                <select id="cfg-grid" class="form-select">
                    <option value="0">1¬™ Parte (Padr√£o)</option>
                    <option value="1">2¬™ Parte</option>
                    <option value="2">3¬™ Parte</option>
                    <option value="3">4¬™ Parte</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Quantidade de Chances</label>
                <input type="number" id="cfg-chances" class="form-input" value="1" min="1" max="10">
                <small style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem; display: block;">
                    Um bip registrar√° esta quantidade de cartelas em sequ√™ncia.
                </small>
            </div>

            <div class="modal-footer">
                <button onclick="closeSettings()" class="nav-btn">Cancelar</button>
                <button onclick="saveSettings()" class="nav-btn primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script src="js/socket.js"></script>
    <script>
        // DOM Elements
        const elCurrentBall = document.getElementById('current-ball');
        const elHistory = document.getElementById('history-row');
        const elListNear1 = document.getElementById('list-near-1');
        const elListWinners = document.getElementById('list-winners');
        const elMoreNear1 = document.getElementById('more-near-1');
        const elMoreWinners = document.getElementById('more-winners');
        const elManualInput = document.getElementById('manual-num');

        // State
        let drawnNumbers = [];
        let config = {
            maxBalls: 75,
            gridIndex: 0,
            numChances: 1
        };

        // Socket Events
        bingoSocket.on('connected', () => {
            console.log('Painel conectado!');
        });

        bingoSocket.on('sync_status', (data) => {
            // Sincroniza vendas
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = data.totalRegistered + " CARTELAS EM JOGO";

            // Sincroniza bolas
            drawnNumbers = data.drawnNumbers || [];
            elHistory.innerHTML = "";
            drawnNumbers.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'history-ball';
                ball.textContent = num < 10 ? '0' + num : num;
                elHistory.insertBefore(ball, elHistory.firstChild);
            });

            if (drawnNumbers.length > 0) {
                const last = drawnNumbers[drawnNumbers.length - 1];
                elCurrentBall.textContent = last < 10 ? '0' + last : last;
            } else {
                elCurrentBall.textContent = "--";
            }

            // Sincroniza listas
            if (data.winners) updateWinners(data.winners);
            if (data.near_wins) updateNearWins(data.near_wins);

            // Sincroniza Configura√ß√µes
            if (data.maxBalls) config.maxBalls = data.maxBalls;
            if (data.gridIndex) config.gridIndex = data.gridIndex;
            if (data.numChances) config.numChances = data.numChances;
            updateConfigBadge();
        });

        bingoSocket.on('config_updated', (data) => {
            config.maxBalls = data.maxBalls;
            config.gridIndex = data.gridIndex;
            config.numChances = data.numChances;
            updateConfigBadge();

            // Sincroniza campos se o administrador estiver com o modal aberto
            document.getElementById('cfg-balls').value = data.maxBalls;
            document.getElementById('cfg-grid').value = data.gridIndex;
            document.getElementById('cfg-chances').value = data.numChances;
        });

        bingoSocket.on('number_drawn', (data) => {
            const num = data.number;
            drawnNumbers.push(num);
            updateDisplay(num);
        });

        bingoSocket.on('number_cancelled', (data) => {
            const num = data.number;
            // Remove do array
            drawnNumbers = drawnNumbers.filter(n => n !== num);

            // Remove do hist√≥rico visual (primeiro filho)
            if (elHistory.firstChild) elHistory.removeChild(elHistory.firstChild);

            // Atualiza a bola grande para a anterior
            if (drawnNumbers.length > 0) {
                const last = drawnNumbers[drawnNumbers.length - 1];
                elCurrentBall.textContent = last < 10 ? '0' + last : last;
            } else {
                elCurrentBall.textContent = "--";
            }

            // Atualiza listas
            if (data.winners) updateWinners(data.winners);
            if (data.near_wins) updateNearWins(data.near_wins);
        });

        bingoSocket.on('ticket_registered', (data) => {
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = data.totalRegistered + " CARTELAS EM JOGO";
        });

        bingoSocket.on('sales_cleared', (data) => {
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = "0 CARTELAS EM JOGO";
        });

        bingoSocket.on('game_update', (data) => {
            if (data.winners) updateWinners(data.winners);
            if (data.near_wins) updateNearWins(data.near_wins);
        });

        bingoSocket.on('game_started', () => {
            resetBoard();
        });

        // Admin Actions
        function requestNewGame() {
            if (confirm("Deseja iniciar um novo jogo? Isso limpar√° o sorteio atual.")) {
                bingoSocket.send("start_game");
            }
        }

        function undoLast() {
            if (drawnNumbers.length === 0) return;
            if (confirm("Deseja cancelar a √∫ltima bola sorteada (" + drawnNumbers[drawnNumbers.length - 1] + ")?")) {
                bingoSocket.send("undo_last");
            }
        }

        function drawRandomNumber() {
            if (drawnNumbers.length >= config.maxBalls) {
                alert("Todos os n√∫meros j√° foram sorteados!");
                return;
            }

            let num;
            do {
                num = Math.floor(Math.random() * config.maxBalls) + 1;
            } while (drawnNumbers.includes(num));

            bingoSocket.send("draw_number", { number: num });
        }

        function drawManual() {
            const val = parseInt(elManualInput.value);
            if (isNaN(val) || val < 1 || val > config.maxBalls) {
                alert("Por favor, digite um n√∫mero entre 1 e " + config.maxBalls);
                return;
            }

            if (drawnNumbers.includes(val)) {
                alert("Este n√∫mero j√° foi sorteado!");
                return;
            }

            bingoSocket.send("draw_number", { number: val });
            elManualInput.value = '';
        }

        function updateDisplay(number) {
            // Update Big Ball
            // Trigger animation reset
            elCurrentBall.style.animation = 'none';
            elCurrentBall.offsetHeight; /* trigger reflow */
            elCurrentBall.style.animation = null;
            elCurrentBall.textContent = number < 10 ? '0' + number : number;

            // Add to history
            const ball = document.createElement('div');
            ball.className = 'ball animate-fade-in';
            ball.textContent = number;
            // Prepend
            elHistory.insertBefore(ball, elHistory.firstChild);
        }

        function updateWinners(winners) {
            elListWinners.innerHTML = '';

            // Mostrar apenas os 3 primeiros
            const showCount = 3;
            winners.slice(0, showCount).forEach(id => {
                const li = document.createElement('li');
                li.className = 'ticket-item winner animate-fade-in';
                li.innerHTML = `<span>Cartela #${id}</span> <span>üèÜ</span>`;
                elListWinners.appendChild(li);
            });

            // Indicador de mais itens
            if (winners.length > showCount) {
                elMoreWinners.textContent = `+ ${winners.length - showCount} GANHADORES`;
                elMoreWinners.style.display = 'block';
            } else {
                elMoreWinners.style.display = 'none';
            }
        }

        function updateNearWins(nearWins) {
            // Focus on "1" missing
            if (nearWins["1"]) {
                const ids = nearWins["1"];
                elListNear1.innerHTML = '';

                const showCount = 3;
                ids.slice(0, showCount).forEach(id => {
                    const li = document.createElement('li');
                    li.className = 'ticket-item near-1 animate-fade-in';
                    li.innerHTML = `<span>Cartela #${id}</span> <span>Falta 1</span>`;
                    elListNear1.appendChild(li);
                });

                if (ids.length > showCount) {
                    elMoreNear1.textContent = `+ ${ids.length - showCount} CARTELAS BOA`;
                    elMoreNear1.style.display = 'block';
                } else {
                    elMoreNear1.style.display = 'none';
                }
            }
        }

        function resetBoard() {
            elCurrentBall.textContent = "--";
            elHistory.innerHTML = "";
            elListNear1.innerHTML = "";
            elListWinners.innerHTML = "";
            elMoreNear1.style.display = 'none';
            elMoreWinners.style.display = 'none';
            drawnNumbers = [];
        }

        // Settings Modal Logic
        function openSettings() {
            document.getElementById('modal-settings').style.display = 'flex';
            // Preenche campos com config atual
            document.getElementById('cfg-balls').value = config.maxBalls;
            document.getElementById('cfg-grid').value = config.gridIndex;
            document.getElementById('cfg-chances').value = config.numChances;
        }

        function closeSettings() {
            document.getElementById('modal-settings').style.display = 'none';
        }

        function saveSettings() {
            const maxBalls = parseInt(document.getElementById('cfg-balls').value);
            const gridIndex = parseInt(document.getElementById('cfg-grid').value);
            const numChances = parseInt(document.getElementById('cfg-chances').value);

            bingoSocket.send("update_config", {
                maxBalls,
                gridIndex,
                numChances
            });

            closeSettings();
        }

        function updateConfigBadge() {
            const badge = document.getElementById('mode-display');
            if (badge) {
                badge.textContent = `${config.maxBalls} Bolas | Grade ${parseInt(config.gridIndex) + 1} | ${config.numChances} Chance(s)`;
            }
            // Atualiza o placeholder do manual input
            elManualInput.max = config.maxBalls;
        }
    </script>
</body>

</html>