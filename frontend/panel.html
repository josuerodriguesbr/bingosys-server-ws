<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingoSys - Painel Ao Vivo</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        body {
            overflow-y: auto;
            min-height: 100vh;
        }

        /* Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 1rem;
            padding: 1rem;
            min-height: 100vh;
        }

        /* Mobile Responsiveness */
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: visible;
            }

            .main-grid aside,
            .main-grid main {
                height: auto !important;
                min-height: unset;
            }

            /* Order: Main Content -> Boa -> Ganhadores */
            .main-grid main {
                order: 1;
            }

            .main-grid aside:nth-of-type(1) {
                order: 2;
            }

            .main-grid aside:nth-of-type(2) {
                order: 3;
            }

            .ticket-list {
                max-height: 300px !important;
            }

            .big-ball {
                width: 60vw !important;
                height: 60vw !important;
                font-size: 20vw !important;
            }

            .admin-controls {
                position: relative !important;
                top: 0 !important;
                right: 0 !important;
                margin-bottom: 2rem;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        /* Last Calls Bar */
        .balls-history {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .ball.last {
            background: var(--warning);
            color: #000;
            border-color: #fff;
            transform: scale(1.1);
        }

        /* Current Call - The Big One */
        .main-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            min-height: 100%;
            position: relative;
        }

        .current-ball-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            flex: 0 0 auto;
            width: 100%;
            padding-top: 2rem;
            position: relative;
        }

        .info-badge {
            position: absolute;
            top: 0.5rem;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.6rem 0.8rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .info-badge.left {
            left: 0.5rem;
        }

        .info-badge.right {
            right: 0.5rem;
        }

        .counter-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .counter-value {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--accent-glow);
            line-height: 1;
        }

        .big-ball {
            width: clamp(200px, 30vw, 400px);
            height: clamp(200px, 30vw, 400px);
            background: radial-gradient(circle at 30% 30%, #3b82f6, #1e40af);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(4rem, 10vw, 8rem);
            font-weight: 900;
            color: white;
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.5), inset 0 0 30px rgba(255, 255, 255, 0.2);
            margin: 1.5rem 0;
            border: 4px solid rgba(255, 255, 255, 0.1);
            position: relative;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .app-layout {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: auto;
            }

            aside {
                height: auto;
            }

            .big-ball {
                width: 65vw;
                height: 65vw;
                font-size: 5rem;
                margin: 1rem 0;
            }

            .main-display {
                display: flex !important;
                flex-direction: column !important;
                overflow-y: auto !important;
                height: auto !important;
                padding-bottom: 2rem !important;
            }

            .current-ball-display {
                height: auto !important;
                min-height: 300px;
                padding: 1rem 0;
                justify-content: flex-start;
            }

            .admin-controls {
                position: relative !important;
                top: auto !important;
                right: auto !important;
                width: 100% !important;
                margin: 1rem 0 !important;
                order: 2;
            }

            .history-container {
                position: relative !important;
                bottom: auto !important;
                left: auto !important;
                right: auto !important;
                margin-top: 1rem;
                width: 100%;
                order: 3;
                background: rgba(0, 0, 0, 0.2) !important;
                border-radius: var(--radius-md);
            }

            .input-manual {
                width: 80px;
                font-size: 1.5rem;
            }

            .top-navbar {
                padding: 0.5rem 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .nav-actions {
                width: 100%;
                justify-content: center;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .nav-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }
        }

        @media (max-width: 480px) {
            .big-ball {
                width: 70vw;
                height: 70vw;
                font-size: 4rem;
            }

            .admin-controls>div {
                width: 100%;
                justify-content: center;
                border-right: none;
                padding-right: 0;
                margin-right: 0;
                margin-bottom: 0.5rem;
            }

            .admin-controls button {
                flex: 1;
                font-size: 0.75rem;
                padding: 0.6rem 0.4rem;
            }
        }

        /* Lists */
        .ticket-list {
            list-style: none;
        }

        .ticket-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--text-secondary);
        }

        .ticket-item.winner {
            background: rgba(34, 197, 94, 0.2);
            border-left-color: var(--success);
            animation: pulse 2s infinite;
        }

        .ticket-item.near-1 {
            border-left-color: var(--warning);
        }

        /* Bingo Grid Visualization */
        .ticket-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: visible;
            /* Mudado de hidden para visible */
            transition: all 0.3s;
            height: auto !important;
            /* For√ßa altura autom√°tica */
            flex: none !important;
            /* Impede que o flex estique ou comprima o card */
        }

        .ticket-card.winner {
            /* Default fallback */
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }

        .ticket-card.winner-cheia {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }

        .ticket-card.winner-quina {
            border-color: #f59e0b;
            /* Amber */
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }

        .ticket-card.winner-forma {
            border-color: #8b5cf6;
            /* Violet */
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        /* Header colors override */
        .ticket-card.winner-quina .ticket-header span:first-child {
            color: #f59e0b !important;
        }

        .ticket-card.winner-forma .ticket-header span:first-child {
            color: #8b5cf6 !important;
        }

        /* NEAR WINS (Falta 1) */
        .ticket-card.near-1 {
            border-color: var(--warning);
        }

        .ticket-card.near-cheia {
            border-color: var(--warning);
        }

        .ticket-card.near-quina {
            border-color: rgba(245, 158, 11, 0.6);
            /* border-left: 4px solid #f59e0b; */
        }

        .ticket-card.near-forma {
            border-color: rgba(139, 92, 246, 0.6);
        }

        /* HEADER STYLES (Solid Backgrounds) */
        .ticket-card .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -1rem -1rem 0.5rem -1rem;
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
            font-weight: 800;
            background: #1e293b;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Prize Table Layout (Q, F, C Columns) */
        .prize-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .prize-row {
            display: grid;
            grid-template-columns: 30px 30px 1fr 30px;
            gap: 2px;
            margin-bottom: 2px;
            align-items: stretch;
        }

        .prize-cell {
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 2px;
        }

        /* Colors based on prize type */
        .cell-type-q {
            background: #f97316;
            color: #000;
        }

        /* Orange */
        .cell-type-f {
            background: #facc15;
            color: #000;
        }

        /* Yellow/Gold */
        .cell-type-c {
            background: #22c55e;
            color: #000;
        }

        /* Green */

        .prize-desc {
            justify-content: flex-start;
            text-align: left;
            padding-left: 8px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .prize-count {
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Near headers */
        .ticket-card.near-1 .ticket-header,
        .ticket-card.near-cheia .ticket-header {
            background: #854d0e;
            color: #fff;
        }



        .bingo-container {
            user-select: none;
        }

        .bingo-labels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            text-align: center;
            font-weight: 900;
            color: var(--accent-glow);
            font-size: 0.75rem;
            margin-bottom: 4px;
            letter-spacing: 2px;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }

        .bingo-cell {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            border-radius: 4px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .bingo-cell.marked {
            background: rgba(34, 197, 94, 0.3);
            border-color: var(--success);
            color: white;
            box-shadow: inset 0 0 8px rgba(34, 197, 94, 0.2);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        .bingo-cell.marked.cell-winner-cheia {
            background: #22c55e !important;
            color: #fff !important;
            border-color: #fff !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .bingo-cell.marked.cell-winner-forma {
            background: #facc15 !important;
            /* Amarelo/Ouro para Formas */
            color: #000 !important;
            border-color: #000 !important;
            box-shadow: 0 0 8px rgba(250, 204, 21, 0.5);
            font-weight: bold;
        }

        .bingo-cell.marked.cell-winner-quina {
            background: #f97316 !important;
            /* Laranja para Quinas */
            color: #fff !important;
            border-color: #fff !important;
            border-radius: 50% !important;
            /* C√≠rculo */
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.6);
            font-weight: 900;
            transform: scale(1.1);
            z-index: 2;
        }

        /* Responsive Winner List: Horizontal on Large Screens */
        @media (min-width: 1400px) {
            .main-grid {
                grid-template-columns: 320px 1fr 2fr;
                /* More space for winners */
            }

            #list-winners {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1rem;
                overflow-y: auto;
                /* Scroll vertical se necess√°rio */
                align-items: start;
                /* Alinha cards no topo, permitindo alturas diferentes */
            }
        }

        /* Admin Controls */
        .admin-controls {
            display: flex;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.8);
            padding: 1rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            z-index: 100;
            flex-wrap: wrap;
            justify-content: center;
            width: auto;
            max-width: 90%;
        }

        .input-manual {
            width: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .more-badge {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.5rem;
            text-align: center;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-style: italic;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            margin-top: 0.5rem;
        }

        .sorteio-id-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            border: 1px solid var(--accent-glow);
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 2px;
        }

        /* Top Menu Bar */
        .top-navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-glow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .nav-btn.primary {
            background: var(--accent-primary);
            border-color: transparent;
        }

        /* Modal Settings */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: var(--bg-secondary);
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
        }

        .form-select {
            width: 100%;
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        .form-select option {
            background: #0f172a;
            color: white;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .mode-badge {
            font-size: 0.75rem;
            background: rgba(var(--accent-primary-rgb), 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            color: var(--accent-glow);
            border: 1px solid rgba(var(--accent-primary-rgb), 0.3);
        }

        .history-container {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-top: auto;
        }

        /* Prize/Shape Editor Styles */
        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.8rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prize-info {
            display: flex;
            flex-direction: column;
        }

        .prize-name {
            font-weight: 700;
            color: #fff;
        }

        .prize-type {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .shape-editor-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            text-align: center;
        }

        .shape-editor-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            width: fit-content;
            margin: 1.5rem auto;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shape-cell {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .shape-cell:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .shape-cell.active {
            background: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
            border-color: #fff;
        }

        /* Ocultar barra de rolagem mantendo funcionalidade */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body>

    <nav class="top-navbar">
        <div class="nav-logo">BINGOSYS</div>
        <div id="game-status-badge" class="nav-actions">
            <div id="mode-display" class="mode-badge">75 Bolas | 1 Chance</div>
            <button id="btn-invite" onclick="copyInviteLink()" class="nav-btn"
                style="border-color: #10b981; color: #10b981;">üîó CONVITE</button>
            <a href="vendas.html" id="btn-sales" class="nav-btn">üõí VENDAS</a>
            <button id="btn-prizes" onclick="openPrizes()" class="nav-btn">üèÜ PREMIA√á√ïES</button>
            <button id="btn-settings" onclick="openSettings()" class="nav-btn">‚öôÔ∏è CONFIGURA√á√ïES</button>
            <button onclick="logout()" class="nav-btn" style="color: var(--danger)">üö™ SAIR</button>
        </div>
    </nav>

    <div class="main-grid">
        <!-- Left: Near Wins (Good) -->
        <aside id="aside-near-1" class="glass-panel no-scrollbar"
            style="padding: 1rem; display: flex; flex-direction: column;">
            <div id="section-boa">
                <div class="section-title">Boa (Falta 1)</div>
                <div id="list-near-1">
                    <!-- Items injected via JS -->
                </div>
                <div id="more-near-1" class="more-badge" style="display: none;"></div>
            </div>

            <div id="section-my-tickets" style="display: none; flex: 1; flex-direction: column;">
                <div class="section-title" style="color: #10b981; border-color: #10b981;">Minhas Cartelas</div>
                <div id="list-my-tickets">
                    <!-- Participantes as cartelas aqui -->
                </div>
            </div>
        </aside>

        <!-- Center: Highlights -->
        <main class="glass-panel main-display">
            <div class="current-ball-display">
                <div class="info-badge left">
                    <span class="counter-label">TIPO</span>
                    <span id="draw-type-display" class="counter-value"
                        style="font-size: 1.1rem; padding: 0.2rem 0;">--</span>
                </div>
                <div class="info-badge right">
                    <span class="counter-label">BOLAS</span>
                    <span id="total-balls-count" class="counter-value">0</span>
                </div>
                <div
                    style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase;">
                    √öltima Bola</div>
                <div id="current-ball" class="big-ball">--</div>
                <div id="sorteio-label" class="sorteio-id-box">PROVA #001</div>
                <div id="playing-count"
                    style="margin-top: 0.5rem; color: var(--success); font-size: 0.9rem; font-weight: 600;">0 CARTELAS
                    EM JOGO</div>
                <div id="draw-warning"
                    style="display: none; margin-top: 1rem; padding: 0.75rem 1.5rem; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: var(--radius-md); color: #fecaca; font-size: 0.85rem; text-align: center; max-width: 80%;">
                    <!-- Warning message here -->
                </div>
            </div>

            <!-- Admin Controls -->
            <div class="admin-controls">
                <div
                    style="display: flex; align-items: center; gap: 0.5rem; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 1rem; margin-right: 0.5rem;">
                    <input type="number" id="manual-num" class="input-manual" placeholder="00" min="1" max="99">
                    <button id="btn-confirm" onclick="drawManual()"
                        style="background: var(--accent-primary); color: white; border: none; padding: 0.6rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 700;">CONFIRMAR</button>
                </div>
                <button id="btn-random" onclick="drawRandomNumber()"
                    style="background: var(--success); color: white; border: none; padding: 0.6rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 700;">ALEAT√ìRIO</button>
                <button id="btn-undo" onclick="undoLast()"
                    style="background: var(--warning); color: #000; border: none; padding: 0.6rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 700;">DESFAZER</button>
                <button id="btn-reset" onclick="requestNewGame()"
                    style="background: #ef4444; color: white; border: none; padding: 0.6rem 1rem; border-radius: var(--radius-md); cursor: pointer; font-weight: 700;">RESET</button>
            </div>

            <!-- Bottom: History -->
            <div class="history-container">
                <div
                    style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                    Hist√≥rico de Bolas</div>
                <div id="history-row" class="balls-history">
                    <!-- Balls injected here -->
                </div>
            </div>
        </main>

        <!-- Right: Winners -->
        <aside id="aside-winners" class="glass-panel no-scrollbar"
            style="padding: 1rem; display: flex; flex-direction: column;">
            <div class="section-title" style="color: var(--success); border-color: var(--success);">Ganhadores!</div>
            <div id="list-winners">
                <!-- Winners... -->
            </div>
            <div id="more-winners" class="more-badge" style="display: none;"></div>
        </aside>
    </div>

    <!-- Modal Preferences -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">Configura√ß√µes do Sorteio</div>
            </div>

            <div class="form-group">
                <label class="form-label">Modelo (Template)</label>
                <select id="cfg-modelo" class="form-select" onchange="aplicarModelo(this.value)">
                    <!-- Dinamicamente preenchido -->
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Base de Dados</label>
                <select id="cfg-base" class="form-select">
                    <!-- Dinamicamente preenchido -->
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Quantidade de Chances</label>
                <input type="number" id="cfg-chances" class="form-input" value="1" min="1" max="10">
                <small style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem; display: block;">
                    Um bip registrar√° esta quantidade de cartelas em sequ√™ncia.
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">Limite de Hist√≥rico (P√∫blico)</label>
                <input type="number" id="cfg-history-limit" class="form-input" value="10" min="1" max="50">
                <small style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem; display: block;">
                    Quantidade de √∫ltimas bolas que aparecem na tela do cliente.
                </small>
            </div>

            <div class="modal-footer">
                <button onclick="closeSettings()" class="nav-btn">Cancelar</button>
                <button onclick="salvarComoModelo()" class="nav-btn"
                    style="border-color: #f59e0b; color: #f59e0b;">Salvar como Modelo</button>
                <button onclick="saveSettings()" class="nav-btn primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Modal Prizes -->
    <div id="modal-prizes" class="modal-overlay">
        <div class="modal-card" style="width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <div class="modal-title">Gest√£o de Premia√ß√µes</div>
                <button onclick="closePrizes()"
                    style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <div class="section-title" style="font-size: 0.9rem;">Pr√™mios Ativos</div>
                <div id="prizes-list-container" style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
                    <!-- Lista de pr√™mios dinamicamente aqui -->
                </div>
            </div>

            <div class="section-title" style="font-size: 0.9rem;">Adicionar Novo Pr√™mio</div>
            <div class="form-group">
                <label class="form-label">Descri√ß√£o do Pr√™mio</label>
                <input type="text" id="prz-nome" class="form-input" placeholder="Ex: TV 50 Pol, Geladeira...">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo de Vit√≥ria</label>
                <select id="prz-tipo" class="form-select" onchange="togglePrizeEditor(this.value)">
                    <option value="quina">Quina (Horizontal, Vertical ou Diag)</option>
                    <option value="forma">Forma (Desenho Customizado)</option>
                    <option value="cheia">Cartela Cheia (Bingo)</option>
                </select>
            </div>

            <div id="prz-shape-editor" class="shape-editor-container" style="display: none;">
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Clique no grid para
                    desenhar o padr√£o:</div>
                <div id="shape-grid" class="shape-editor-grid">
                    <!-- Gerado via JS -->
                </div>
                <button onclick="clearShapeGrid()" class="nav-btn"
                    style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">Limpar Grade</button>
            </div>

            <div class="modal-footer">
                <button onclick="closePrizes()" class="nav-btn">Fechar</button>
                <button onclick="saveNewPrize()" class="nav-btn primary">Adicionar √† Lista</button>
            </div>
        </div>
    </div>

    <script src="js/socket.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check access before doing anything
        if (!BingoAuth.checkAccess(true)) {
            // checkAccess handles redirect
        }
        // DOM Elements
        const elCurrentBall = document.getElementById('current-ball');
        const elHistory = document.getElementById('history-row');
        const elListNear1 = document.getElementById('list-near-1');
        const elListWinners = document.getElementById('list-winners');
        const elMoreNear1 = document.getElementById('more-near-1');
        const elMoreWinners = document.getElementById('more-winners');
        const elManualInput = document.getElementById('manual-num');

        // State
        let drawnNumbers = [];
        let myTickets = [];
        let session = BingoAuth.getSession();

        let lastWinners = [];
        let lastNearWins = {};
        let config = {
            maxBalls: 75,
            gridIndex: 0,
            numChances: 1,
            modeName: " Bingo 75 x 15 (Cl√°ssico)",
            historyLimit: 10
        };
        let availableModes = [];
        let showAllWinners = false;
        let showAllNear1 = false;
        let isGameFinished = false;
        let isDrawing = false; // Flag para evitar double-click e n√∫meros fantasmas

        function updateResetButtonState() {
            const btnReset = document.getElementById('btn-reset');
            const btnConfirm = document.getElementById('btn-confirm');
            const btnRandom = document.getElementById('btn-random');
            const btnUndo = document.getElementById('btn-undo');
            const inputManual = document.getElementById('manual-num');

            if (isGameFinished) {
                // TRAVA TOTAL DE ENTRADA (Solicita√ß√£o Cr√≠tica)
                if (btnConfirm) btnConfirm.disabled = true;
                if (btnRandom) btnRandom.disabled = true;
                if (inputManual) {
                    inputManual.disabled = true;
                    inputManual.style.opacity = '0.5';
                }
                if (btnReset) {
                    btnReset.style.opacity = '0.5';
                    btnReset.style.pointerEvents = 'none';
                    btnReset.disabled = true;
                    btnReset.title = "Sorteio conclu√≠do. A chave foi inativada.";
                }
                // O Desfazer deve continuar habilitado para permitir reabrir o sorteio
                if (btnUndo) {
                    btnUndo.disabled = false;
                    btnUndo.style.opacity = '1';
                }
            } else {
                // LIBERA ENTRADA (Se n√£o estiver no meio de um processamento de bola)
                const disabledByDrawing = isDrawing;

                if (btnConfirm) btnConfirm.disabled = disabledByDrawing;
                if (btnRandom) btnRandom.disabled = disabledByDrawing;
                if (btnUndo) btnUndo.disabled = (drawnNumbers.length === 0 || disabledByDrawing);
                if (inputManual) {
                    inputManual.disabled = disabledByDrawing;
                    inputManual.style.opacity = disabledByDrawing ? '0.5' : '1';
                }
                if (btnReset) {
                    btnReset.style.opacity = '1';
                    btnReset.style.pointerEvents = 'auto';
                    btnReset.disabled = disabledByDrawing;
                    btnReset.title = "";
                }
            }
        }

        function copyInviteLink() {
            const url = window.location.origin + window.location.pathname.replace('panel.html', 'login.html') + '?chave=' + session.chave;
            navigator.clipboard.writeText(url).then(() => {
                alert("Link de convite copiado!\n\nEnvie para os participantes:\n" + url);
            });
        }

        function checkParticipantMode() {
            if (session.isOperator) {
                // For√ßa a exibi√ß√£o dos controles se for operador
                document.querySelector('.admin-controls').style.display = 'flex';
                document.getElementById('btn-sales').style.display = 'block';
                document.getElementById('btn-settings').style.display = 'block';
                document.getElementById('btn-invite').style.display = 'block';
                if (document.getElementById('btn-prizes')) document.getElementById('btn-prizes').style.display = 'block';

                document.getElementById('section-boa').style.display = 'block';
                document.getElementById('section-my-tickets').style.display = 'none';
            } else if (session.telefone) {
                // Modo Participante puro
                document.querySelector('.admin-controls').style.display = 'none';
                document.getElementById('btn-sales').style.display = 'none';
                document.getElementById('btn-settings').style.display = 'none';
                document.getElementById('btn-invite').style.display = 'none';

                document.getElementById('section-boa').style.display = 'none';
                document.getElementById('section-my-tickets').style.display = 'flex';

                bingoSocket.send('get_my_tickets', { telefone: session.telefone });
            }
        }

        bingoSocket.on('connected', () => {
            console.log("Conectado ao servidor. Sincronizando sess√£o...");
            const sess = BingoAuth.getSession();
            if (sess.chave) {
                bingoSocket.send('login', { chave: sess.chave });
            } else {
                window.location.href = 'login.html';
            }
        });

        bingoSocket.on('login_success', (data) => {
            console.log('Painel autenticado!');
            session = BingoAuth.getSession(); // Recarrega dados atualizados (como isOperator)
            checkParticipantMode();
        });

        bingoSocket.on('server_debug_report', (data) => {
            console.group("üöÄ RELAT√ìRIO DE DEPURA√á√ÉO DO SERVIDOR");
            console.table(data.prizes.map(p => ({
                ID: p.id,
                Nome: p.nome,
                Tipo: p.tipo,
                Ativo: p.active,
                Realizado: p.realizada,
                "Na Vez?": p.isTurnPrize ? "SIM" : "n√£o",
                Ganhadores: p.winnersCount
            })));
            console.log("Estado Geral:", {
                BolasSorteada: data.drawnCount,
                CartelasAtivas: data.activeTicketsCount,
                IndexGrade: data.gridIndex
            });
            console.groupEnd();
            alert("Relat√≥rio de depura√ß√£o gerado no console do navegador (F12)!");
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                console.log("Solicitando relat√≥rio de depura√ß√£o...");
                bingoSocket.send('get_server_debug', {});
            }
        });

        bingoSocket.on('my_tickets_response', (data) => {
            myTickets = data.tickets || [];
            renderMyTickets();
        });

        function renderMyTickets() {
            const el = document.getElementById('list-my-tickets');
            el.innerHTML = "";
            myTickets.forEach(ticket => {
                const div = document.createElement('div');
                div.className = 'ticket-card';
                div.innerHTML = `
                    <div class="ticket-header">
                        <span>üè∑Ô∏è #${ticket.barcode}</span>
                    </div>
                    ${renderBingoGrid(ticket.numbers)}
                `;
                el.appendChild(div);
            });
        }

        bingoSocket.on('sync_status', (data) => {
            // Sincroniza vendas
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = data.totalRegistered + " CARTELAS EM JOGO";

            // Sincroniza bolas
            drawnNumbers = data.drawnNumbers || [];
            updateTotalBallsCounter();
            elHistory.innerHTML = "";
            drawnNumbers.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'ball animate-fade-in'; // Usando classe consistente
                ball.textContent = num < 10 ? '0' + num : num;
                elHistory.insertBefore(ball, elHistory.firstChild);
            });

            if (drawnNumbers.length > 0) {
                const last = drawnNumbers[drawnNumbers.length - 1];
                elCurrentBall.textContent = last < 10 ? '0' + last : last;
            } else {
                elCurrentBall.textContent = "--";
            }

            // Sincroniza listas (Usa aggregateWinners para juntar todos)
            lastWinners = aggregateWinners(data);
            updateWinners(lastWinners);
            if (data.near_wins) {
                lastNearWins = data.near_wins;
                updateNearWins(lastNearWins);
            }

            // Sincroniza Configura√ß√µes
            if (data.maxBalls) config.maxBalls = data.maxBalls;
            if (data.gridIndex) config.gridIndex = data.gridIndex;
            if (data.numChances) config.numChances = data.numChances;
            if (data.historyLimit) config.historyLimit = data.historyLimit;
            if (data.tipo_grade) config.tipo_grade = data.tipo_grade;

            if (data.modes) {
                availableModes = data.modes;
                populateModesList();
            }

            isGameFinished = !!data.isFinished;
            isDrawing = false;
            updateResetButtonState();

            renderMyTickets();
            updateConfigBadge();
        });

        bingoSocket.on('config_updated', (data) => {
            config.maxBalls = data.maxBalls;
            config.gridIndex = data.gridIndex;
            config.numChances = data.numChances;
            config.historyLimit = data.historyLimit;
            if (data.tipo_grade) config.tipo_grade = data.tipo_grade;
            updateConfigBadge();
        });

        bingoSocket.on('number_drawn', (data) => {
            console.log("Bola sorteada:", data.number);
            const num = data.number;

            // Evita duplicados se o sync vier quase junto
            if (!drawnNumbers.includes(num)) {
                drawnNumbers.push(num);
                updateDisplay(num);
                updateTotalBallsCounter();
            }

            // Atualiza ganhadores unificando listas
            lastWinners = aggregateWinners(data);

            updateWinners(lastWinners);
            updateNearWins(lastNearWins);

            isGameFinished = !!data.isFinished;
            isDrawing = false; // Libera
            updateResetButtonState();

            renderMyTickets();
        });

        bingoSocket.on('number_cancelled', (data) => {
            const num = data.number;
            // Remove do array
            drawnNumbers = drawnNumbers.filter(n => n !== num);
            updateTotalBallsCounter();

            // Remove do hist√≥rico visual (primeiro filho)
            if (elHistory.firstChild) elHistory.removeChild(elHistory.firstChild);

            // Atualiza a bola grande para a anterior
            if (drawnNumbers.length > 0) {
                const last = drawnNumbers[drawnNumbers.length - 1];
                elCurrentBall.textContent = last < 10 ? '0' + last : last;
            } else {
                elCurrentBall.textContent = "--";
            }

            // Atualiza listas unificadas para refletir a remo√ß√£o do ganhador
            lastWinners = aggregateWinners(data);
            if (data.near_wins) lastNearWins = data.near_wins;

            updateWinners(lastWinners);
            updateNearWins(lastNearWins);

            isGameFinished = !!data.isFinished;
            isDrawing = false; // Libera
            updateResetButtonState();

            renderMyTickets();
        });

        bingoSocket.on('ticket_registered', (data) => {
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = data.totalRegistered + " CARTELAS EM JOGO";
        });

        bingoSocket.on('sales_cleared', (data) => {
            const elPlaying = document.getElementById('playing-count');
            if (elPlaying) elPlaying.textContent = "0 CARTELAS EM JOGO";
        });

        bingoSocket.on('game_update', (data) => {
            if (data.winners) updateWinners(data.winners);
            if (data.near_wins) updateNearWins(data.near_wins);
        });

        bingoSocket.on('game_started', () => {
            drawnNumbers = [];
            updateTotalBallsCounter();
            resetBoard();
        });

        function updateTotalBallsCounter() {
            const el = document.getElementById('total-balls-count');
            if (el) el.textContent = drawnNumbers.length;
        }

        // Admin Actions
        function requestNewGame() {
            if (isGameFinished) {
                alert("Este sorteio j√° foi conclu√≠do e n√£o pode ser reiniciado. A chave de acesso foi inativada.");
                return;
            }
            if (confirm("Deseja iniciar um novo jogo? Isso limpar√° o sorteio atual.")) {
                bingoSocket.send("start_game");
            }
        }

        function undoLast() {
            if (isDrawing) return;
            if (drawnNumbers.length === 0) return;
            if (confirm("Deseja cancelar a √∫ltima bola sorteada (" + drawnNumbers[drawnNumbers.length - 1] + ")?")) {
                isDrawing = true;
                updateResetButtonState();
                bingoSocket.send("undo_last");
            }
        }

        function drawRandomNumber() {
            if (isGameFinished) {
                alert("Sorteio j√° conclu√≠do!");
                return;
            }
            if (isDrawing) return;

            if (drawnNumbers.length >= config.maxBalls) {
                alert("Todos os n√∫meros j√° foram sorteados!");
                return;
            }

            let num;
            do {
                num = Math.floor(Math.random() * config.maxBalls) + 1;
            } while (drawnNumbers.includes(num));

            isDrawing = true;
            updateResetButtonState();
            bingoSocket.send("draw_number", { number: num });
        }

        function drawManual() {
            if (isGameFinished) {
                alert("Sorteio j√° conclu√≠do!");
                return;
            }
            if (isDrawing) return;

            const val = parseInt(elManualInput.value);
            if (isNaN(val) || val < 1 || val > config.maxBalls) {
                alert("Por favor, digite um n√∫mero entre 1 e " + config.maxBalls);
                return;
            }

            if (drawnNumbers.includes(val)) {
                alert("Este n√∫mero j√° foi sorteado!");
                return;
            }

            isDrawing = true;
            updateResetButtonState();
            bingoSocket.send("draw_number", { number: val });
            elManualInput.value = '';
        }

        function updateDisplay(number) {
            // Update Big Ball
            elCurrentBall.textContent = number < 10 ? '0' + number : number;

            // Re-trigger popIn animation
            elCurrentBall.style.animation = 'none';
            void elCurrentBall.offsetWidth; // trigger reflow
            elCurrentBall.style.animation = 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            // Add to history
            const ball = document.createElement('div');
            ball.className = 'ball animate-fade-in';
            ball.textContent = number < 10 ? '0' + number : number;
            // Prepend
            elHistory.insertBefore(ball, elHistory.firstChild);
        }

        function updateWinners(winners) {
            lastWinners = winners || [];
            elListWinners.innerHTML = "";
            let toShow = [...lastWinners];

            elMoreWinners.style.display = 'none';

            toShow.forEach(ticket => {
                try {
                    const div = document.createElement('div');
                    // Unifica premia√ß√µes da mesma cartela
                    const prizes = ticket.allPrizes || [{
                        type: ticket.winType || 'cheia',
                        name: ticket.prizeName || 'GANHOU!',
                        turn: ticket.turn || '1',
                        winnersCount: ticket.winnersCount || 1
                    }];

                    // Classe principal baseada no pr√™mio mais alto
                    const hasCheia = prizes.some(p => p.type === 'cheia');
                    const mainClass = hasCheia ? 'winner-cheia' : 'winner-other';

                    div.className = `ticket-card ${mainClass}`;

                    let prizeRowsHtml = "";
                    prizes.forEach(p => {
                        const typeCode = p.type === 'quina' ? 'Q' : (p.type === 'forma' ? 'F' : 'C');
                        const typeClass = `cell-type-${p.type === 'quina' ? 'q' : (p.type === 'forma' ? 'f' : 'c')}`;
                        const turn = p.type === 'forma' ? '*' : (p.turn || '1');

                        prizeRowsHtml += `
                            <div class="prize-row">
                                <div class="prize-cell ${typeClass}">${typeCode}</div>
                                <div class="prize-cell">${turn}</div>
                                <div class="prize-cell prize-desc">${p.name}</div>
                                <div class="prize-cell prize-count">${p.winnersCount || '1'}</div>
                            </div>
                        `;
                    });

                    // Coleta todos os √≠ndices de padr√µes (forma e quina) ganhos nesta cartela
                    const formaPatterns = prizes
                        .filter(p => p.type === 'forma' && p.padrao)
                        .reduce((acc, p) => acc.concat(p.padrao), []);

                    const quinaPatterns = prizes
                        .filter(p => p.type === 'quina' && p.padrao)
                        .reduce((acc, p) => acc.concat(p.padrao), []);

                    let gridHtml = renderBingoGrid(ticket.numbers, hasCheia, formaPatterns, quinaPatterns);
                    div.innerHTML = `
                        <div class="ticket-header">
                            <span>üè∑Ô∏è #${ticket.barcode}</span>
                            <span style="font-size:0.7em; opacity:0.8">GANHADOR!</span>
                        </div>
                        <div class="prize-table">
                            ${prizeRowsHtml}
                        </div>
                        ${gridHtml}
                    `;
                    elListWinners.appendChild(div);
                } catch (e) { console.error("Erro ao renderizar vencedor:", e); }
            });
        }

        function aggregateWinners(data) {
            let map = new Map();

            // Fun√ß√£o auxiliar para agrupar
            const add = (ticket, prizeInfo) => {
                if (!map.has(ticket.ticketId)) {
                    map.set(ticket.ticketId, { ...ticket, allPrizes: [] });
                }
                map.get(ticket.ticketId).allPrizes.push(prizeInfo);
            };

            // 2. Pr√™mios Customizados (Unificada - Quinas, Formas e Cheias via Turno Global)
            if (data.prizes && Array.isArray(data.prizes)) {
                data.prizes.forEach(p => {
                    if (p.winners && Array.isArray(p.winners)) {
                        p.winners.forEach(w => {
                            add(w, {
                                type: p.tipo,
                                name: p.nome,
                                turn: '1',
                                winnersCount: p.winners.length,
                                padrao: w.padrao || p.padrao // Tenta o padr√£o da cartela (quina) ou pr√™mio (forma)
                            });
                        });
                    }
                });
            }
            return Array.from(map.values());
        }

        function aggregateNearWins(data) {
            let byType = {};
            // 1. Bingo Cheio (padr√£o 'near_wins') -> chave "1" √© falta 1
            if (data.near_wins && data.near_wins["1"]) {
                byType["cheia"] = data.near_wins["1"].map(w => {
                    let o = { ...w };
                    o.winType = 'cheia';
                    o.prizeName = 'BINGO CHEIO';
                    return o;
                });
            }

            // 2. Pr√™mios Customizados (near_winners)
            if (data.prizes && Array.isArray(data.prizes)) {
                data.prizes.forEach(p => {
                    if (p.near_winners && Array.isArray(p.near_winners)) {
                        let formatted = p.near_winners.map(w => {
                            let o = { ...w };
                            o.winType = p.tipo;
                            o.prizeName = p.nome;
                            return o;
                        });
                        // Agrupa tudo sob uma chave, ou mescla?
                        // Vamos mesclar tudo numa lista √∫nica de "Falta 1"
                        if (!byType["custom"]) byType["custom"] = [];
                        byType["custom"] = byType["custom"].concat(formatted);
                    }
                });
            }
            return byType;
        }

        function updateNearWins(nearWinsData) {
            // Suporta formato antigo (objeto direto) ou novo (aggregated)
            // Se veio do socket direto:
            let list = [];

            // Se j√° foi processado por aggregateNearWins:
            if (nearWinsData.cheia) list = list.concat(nearWinsData.cheia);
            if (nearWinsData.custom) list = list.concat(nearWinsData.custom);

            // Filtro de unicidade (uma cartela pode faltar 1 para quina E bingo)
            // Prioridade visual? Se faltar 1 pra bingo e quina, mostra qual?
            // Vamos mostrar duplicado ou apenas o mais importante? 
            // Melhor mostrar duplicado para operado ver todas as chances.

            elListNear1.innerHTML = "";
            let toShow = list;

            if (toShow.length > 5 && !showAllNear1) {
                elMoreNear1.style.display = 'block';
                elMoreNear1.textContent = `+ ${toShow.length - 5} armadas`;
                toShow = toShow.slice(0, 5);
            } else {
                elMoreNear1.style.display = 'none';
            }

            toShow.forEach(ticket => {
                try {
                    const div = document.createElement('div');
                    // Classes visuais para "near"
                    const typeClass = ticket.winType ? `near-${ticket.winType}` : 'near-1';
                    const label = ticket.prizeName ? `FALTA 1 - ${ticket.prizeName}` : 'FALTA 1';

                    div.className = `ticket-card ${typeClass}`;
                    let gridHtml = renderBingoGrid(ticket.numbers);
                    div.innerHTML = `
                        <div class="ticket-header">
                            <span style="color: inherit">üî• #${ticket.barcode}</span>
                            <span style="font-size:0.75em">${label}</span>
                        </div>
                        ${gridHtml}
                    `;
                    elListNear1.appendChild(div);
                } catch (e) { console.error("Erro ao renderizar armada:", e); }
            });
        }

        function renderBingoGrid(numbers, isFullWinner = false, formaPatterns = [], quinaPatterns = []) {
            if (!numbers || numbers.length === 0) return "";

            const rows = numbers.length / 5;
            let html = `
                <div class="bingo-container">
                    <div class="bingo-labels">
                        <div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>
                    </div>
                    <div class="bingo-grid" style="grid-template-rows: repeat(${rows}, 1fr)">
            `;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < 5; c++) {
                    const idx = (c * rows) + r;
                    const val = numbers[idx];
                    const isMarked = drawnNumbers.includes(val);

                    let cellClass = isMarked ? 'marked' : '';
                    if (isFullWinner && isMarked) {
                        cellClass += ' cell-winner-cheia';
                    } else if (quinaPatterns.includes(idx) && isMarked) {
                        cellClass += ' cell-winner-quina';
                    } else if (formaPatterns.includes(idx) && isMarked) {
                        cellClass += ' cell-winner-forma';
                    }

                    html += `<div class="bingo-cell ${cellClass}">${val.toString().padStart(2, '0')}</div>`;
                }
            }
            html += `</div></div>`;
            return html;
        }

        function resetBoard() {
            drawnNumbers = [];
            elHistory.innerHTML = "";
            elCurrentBall.textContent = "--";
            elCurrentBall.classList.remove('animate-pop-in');

            lastWinners = [];
            lastNearWins = {};
            showAllNear1 = false;

            isGameFinished = false;
            updateResetButtonState();
        }

        // Settings Modal Logic
        let modelosCache = [];
        let basesCache = [];

        function openSettings() {
            bingoSocket.send('get_draw_config');
            document.getElementById('modal-settings').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('modal-settings').style.display = 'none';
        }

        bingoSocket.on('draw_config_response', (data) => {
            console.log("draw_config_response recebido:", JSON.stringify(data));
            const d = data.draw;
            console.log("draw object:", JSON.stringify(d));
            console.log("tipo_grade do draw:", d ? d.tipo_grade : "draw √© null");

            const modelSelect = document.getElementById('cfg-modelo');
            const baseSelect = document.getElementById('cfg-base');

            modelosCache = data.modelos || [];
            basesCache = data.bases || [];

            if (modelSelect) modelSelect.innerHTML = modelosCache.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
            if (baseSelect) {
                baseSelect.innerHTML = basesCache.map(b => `<option value="${b.id}">${b.nome} (${b.tipo})</option>`).join('');
                console.log("Select Base preenchido com", basesCache.length, "itens. Tentando selecionar ID:", d.base_id);
                baseSelect.value = d.base_id;

                // Fallback caso n√£o selecione (ex: tipagem String vs Int)
                if (baseSelect.value == "" && d.base_id) {
                    Array.from(baseSelect.options).forEach(opt => {
                        if (opt.value == d.base_id) baseSelect.value = opt.value;
                    });
                }
            }

            if (modelSelect) modelSelect.value = d.modelo_id;

            // Atualiza tipo_grade no config global
            if (d && d.tipo_grade) {
                config.tipo_grade = d.tipo_grade;
                console.log("Config tipo_grade EFETIVAMENTE atualizado para:", config.tipo_grade);

                // Recria o grid de formas se o editor estiver vis√≠vel
                const shapeEditor = document.getElementById('prz-shape-editor');
                if (shapeEditor && shapeEditor.style.display !== 'none') {
                    console.log("Recriando shape grid com tipo_grade:", config.tipo_grade);
                    createShapeGrid();
                }
            } else {
                console.warn("tipo_grade N√ÉO encontrado na resposta do servidor!");
            }

            const p = d ? d.preferencias || {} : {};
            if (document.getElementById('cfg-chances')) document.getElementById('cfg-chances').value = p.numChances || 1;
            if (document.getElementById('cfg-history-limit')) document.getElementById('cfg-history-limit').value = p.historyLimit || 10;
        });

        function aplicarModelo(id) {
            const m = modelosCache.find(mod => mod.id == id);
            if (m && m.config) {
                if (document.getElementById('cfg-history-limit')) document.getElementById('cfg-history-limit').value = m.config.historyLimit || 10;
                if (document.getElementById('cfg-chances')) document.getElementById('cfg-chances').value = m.config.numChances || 1;
            }
        }

        function salvarComoModelo() {
            const nome = prompt("Digite o nome deste novo modelo:");
            if (!nome) return;

            const config = {
                historyLimit: parseInt(document.getElementById('cfg-history-limit').value),
                numChances: parseInt(document.getElementById('cfg-chances').value)
            };

            bingoSocket.send('save_as_template', { nome, config });
            alert("Modelo salvo com sucesso!");
        }

        function saveSettings() {
            const modeloId = parseInt(document.getElementById('cfg-modelo').value);
            const baseId = parseInt(document.getElementById('cfg-base').value);
            const numChances = parseInt(document.getElementById('cfg-chances').value);
            const historyLimit = parseInt(document.getElementById('cfg-history-limit').value);

            console.log("[DEBUG] Salvando Prefer√™ncias:", { modeloId, baseId, numChances, historyLimit });

            bingoSocket.send("update_config", {
                modelo_id: modeloId,
                base_id: baseId,
                preferencias: {
                    numChances: numChances,
                    historyLimit: historyLimit
                }
            });

            closeSettings();
        }

        // --- Gest√£o de Premia√ß√µes ---
        let currentPrizes = [];
        let shapeIndices = new Set();

        function openPrizes() {
            // Solicita config atualizado para garantir tipo_grade correto
            bingoSocket.send('get_draw_config');
            document.getElementById('modal-prizes').style.display = 'flex';
            bingoSocket.send('get_prizes');
        }

        function closePrizes() {
            document.getElementById('modal-prizes').style.display = 'none';
        }

        bingoSocket.on('prizes_list', (data) => {
            currentPrizes = data.prizes || [];
            renderPrizeList();
        });

        bingoSocket.on('draw_number_error', (data) => {
            isDrawing = false; // DESBLOQUEIA em caso de erro
            updateResetButtonState();

            const elWarning = document.getElementById('draw-warning');
            if (elWarning) {
                elWarning.style.display = 'block';
                elWarning.innerHTML = `‚ö†Ô∏è <b>Bloqueio:</b> ${data.message}`;
                // Esconde ap√≥s 8 segundos
                setTimeout(() => { elWarning.style.display = 'none'; }, 8000);
            }
            console.error("Erro de sorteio:", data.message);
        });

        bingoSocket.on('add_prize_error', (data) => {
            alert("Erro ao adicionar pr√™mio: " + data.message);
        });

        bingoSocket.on('prize_status_updated', (data) => {
            console.log("Status do pr√™mio atualizado:", data);
            // Sincroniza estado final se necess√°rio
            if (data.isFinished !== undefined) {
                isGameFinished = !!data.isFinished;
                updateResetButtonState();
            }
        });

        function renderPrizeList() {
            const container = document.getElementById('prizes-list-container');
            if (!currentPrizes.length) {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:1rem;">Nenhum pr√™mio cadastrado.</div>';
                return;
            }
            container.innerHTML = currentPrizes.map(p => {
                const isRealizada = p.realizada;
                return `
                <div class="prize-item" style="${isRealizada ? 'opacity: 0.6; border-left: 4px solid var(--success);' : 'border-left: 4px solid var(--warning);'}">
                    <div class="prize-info">
                        <span class="prize-name">${p.nome} ${isRealizada ? '‚úÖ' : ''}</span>
                        <span class="prize-type">${p.tipo}</span>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        ${session.isOperator ? `
                            <button onclick="finalizePrize(${p.id}, ${!isRealizada})" 
                                    style="background:${isRealizada ? 'var(--text-secondary)' : 'var(--success)'}; border:none; color:#fff; padding:0.3rem 0.6rem; border-radius:4px; font-size:0.7rem; cursor:pointer;">
                                ${isRealizada ? 'Reabrir' : 'Finalizar'}
                            </button>
                            <button onclick="deletePrize(${p.id})" style="background:var(--danger); border:none; color:#fff; padding:0.3rem 0.6rem; border-radius:4px; font-size:0.7rem; cursor:pointer;">Remover</button>
                        ` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function finalizePrize(prizeId, realizada) {
            const acao = realizada ? "finalizar" : "reabrir";
            if (confirm(`Deseja ${acao} este pr√™mio?`)) {
                bingoSocket.send('finalize_prize', { prizeId, realizada });
            }
        }

        function togglePrizeEditor(tipo) {
            const editor = document.getElementById('prz-shape-editor');
            if (tipo === 'forma') {
                editor.style.display = 'block';
                // Solicita config atualizado e depois desenha o grid
                bingoSocket.send('get_draw_config');
                createShapeGrid(); // Desenha imediatamente com o que temos
            } else {
                editor.style.display = 'none';
            }
        }

        function createShapeGrid() {
            const gridEl = document.getElementById('shape-grid');
            gridEl.innerHTML = '';

            // Detecta dimens√µes baseado no tipo_grade (ex: 75x15 -> 15 n√∫meros -> 5x3)
            let cols = 5;
            let rows = 5;
            if (config.tipo_grade && config.tipo_grade.includes('x')) {
                const total = parseInt(config.tipo_grade.split('x')[1]);
                rows = total / cols;
            }

            console.log("Desenhando editor de formas para grade:", config.tipo_grade || "5x5", "Rows:", rows);

            // Ajusta o CSS do grid dinamicamente
            gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gridEl.style.width = 'fit-content';

            const totalCells = cols * rows;
            for (let i = 0; i < totalCells; i++) {
                const r = Math.floor(i / cols);
                const c = i % cols;
                const columnMajorIdx = (c * rows) + r;

                const cell = document.createElement('div');
                cell.className = 'shape-cell';
                if (shapeIndices.has(columnMajorIdx)) cell.classList.add('active');

                cell.onclick = () => {
                    if (shapeIndices.has(columnMajorIdx)) shapeIndices.delete(columnMajorIdx);
                    else shapeIndices.add(columnMajorIdx);
                    cell.classList.toggle('active');
                };
                gridEl.appendChild(cell);
            }
        }

        function clearShapeGrid() {
            shapeIndices.clear();
            createShapeGrid();
        }

        function saveNewPrize() {
            const nomeInput = document.getElementById('prz-nome');
            const nome = nomeInput.value.trim();
            const tipo = document.getElementById('prz-tipo').value;
            if (!nome) return alert("Por favor, informe a descri√ß√£o do pr√™mio.");

            // Valida√ß√£o de nomes duplicados
            const duplicado = currentPrizes.find(p => p.nome.toLowerCase() === nome.toLowerCase());
            if (duplicado) {
                return alert(`J√° existe um pr√™mio cadastrado com o nome "${nome}". Por favor, escolha um nome diferente.`);
            }

            const padrao = (tipo === 'forma') ? Array.from(shapeIndices) : [];

            bingoSocket.send('add_prize', {
                nome, tipo, padrao, ordem: currentPrizes.length + 1
            });

            // Limpa form e reset gr√°fico
            document.getElementById('prz-nome').value = '';
            clearShapeGrid(); // Limpa visualmente a grade e os √≠ndices internos
            alert("Pr√™mio adicionado com sucesso!");
            bingoSocket.send('get_prizes');
        }

        function deletePrize(id) {
            if (confirm("Deseja remover este pr√™mio?")) {
                bingoSocket.send('delete_prize', { id });
                setTimeout(() => bingoSocket.send('get_prizes'), 500);
            }
        }

        function updateConfigBadge() {
            const badge = document.getElementById('mode-display');
            if (badge) {
                badge.textContent = `Sorteio #${drawnNumbers.length > 0 ? "Em Andamento" : "Pronto"}`;
            }

            // Atualiza o novo painel informativo (Tipo de Sorteio)
            const typeDisplay = document.getElementById('draw-type-display');
            if (typeDisplay) {
                typeDisplay.textContent = config.tipo_grade || "75x15";
            }

            if (elManualInput) elManualInput.max = config.maxBalls || 75;
        }

        function logout() {
            if (confirm("Deseja sair do painel?")) {
                BingoAuth.logout();
            }
        }
    </script>
</body>

</html>